---
apiVersion: v1
kind: ConfigMap
metadata:
  name: kuberos-oidc-env
data:
  OIDC_ISSUER_URL: "https://cloud-platform-test-raz.eu.auth0.com/"
  OIDC_CLIENT_ID: "bPdSrivMQAIBCfNGgGmSKLkWoxXtISUm"
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: templates
data:
  kubecfg: |
    apiVersion: v1
    kind: Config
    clusters:
    - cluster:
        certificate-authority-data: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUMwekNDQWJ1Z0F3SUJBZ0lNRlVCVWltZTNSVFIyV3QrUU1BMEdDU3FHU0liM0RRRUJDd1VBTUJVeEV6QVIKQmdOVkJBTVRDbXQxWW1WeWJtVjBaWE13SGhjTk1UZ3dOekE1TVRNME56QTJXaGNOTWpnd056QTRNVE0wTnpBMgpXakFWTVJNd0VRWURWUVFERXdwcmRXSmxjbTVsZEdWek1JSUJJakFOQmdrcWhraUc5dzBCQVFFRkFBT0NBUThBCk1JSUJDZ0tDQVFFQXhlTXFtaVhNbkkzVWNxRlcvblBOSHpNNmdiUnlTZUJyMk5mRDBvdW10cEtnakEwak9PUUkKQU9oTnVLREM4RmtySm85akcwOXZzYzNNOGNyRG9CaE1POSsreFRXaHkyWTMraVlvcmgxRGJUZUk3YU1yYzFSeAo1cFZqRzZnTlJyZ3NwK2Z0TW1UNUdiZzdObjFCM2taNzNhcTFoYjZFUEV1emk2QVd6Z2t2WUw4VlUvbjQydUMyCmZRdWdnNUUySmtNY0Noc1dCRmNjLzlWYlNLdW5mQXlvcEM4MFB0OGZ6bXZ1eHNkSjVLZVdndGZSWDAyVnc5VHEKc2FrMnR1dmtVdDhZcDVJVFdTb0tjMlRvTUFOSDVqd2RiZ3E1LzRWeEJaZW80eW1NU20vMkM3bkV5OHNSd3VBYwptNkNIZnZVcWJkVDhoL2ZHWnU0aUEyYXBVR3poRHBqZ2J3SURBUUFCb3lNd0lUQU9CZ05WSFE4QkFmOEVCQU1DCkFRWXdEd1lEVlIwVEFRSC9CQVV3QXdFQi96QU5CZ2txaGtpRzl3MEJBUXNGQUFPQ0FRRUFjRm1idm1PVzVpcVgKcVA0NmNvWFh5VmdjZVNnT0tlK0xnb2U4bFc5YWZuR3VsR0EwWHYybFU5eFpKSERZSVUzdmo1c1FGdDBJU280cwpxL2JXdDhLLzUwT0hSam4zek5sY0F0dHZkTFAzaElCVnFsRlFCaCswVGFnaitEU2dyTDhxZGROYWVnczdib0lZCmwrbDdNNzc5R0tvdHgvVnA4ZUtlZnIwZE5yemVzR1NGeHJyVFBiWWhxc0dzMzh2R3ZmR0lPMHE0T3ZnQXlsaU4KSGN6ZXZPQ1hmaW9ITW4rNkp1ODMwbHRJTTZZbDRrc1d3d3Znakg1dVJETktxeU1WR0pFeU0vU2VMSlJyYkY2YwowcnlpMS9LRlVyMlFORkFUR1NveVNRR3JkVDE2eENHbHZTZHRLV09IdEcwMUpSYjN0OG5sU21icG5uSWhBT3FKCmNIY3VEV05iMlE9PQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==
        server: https://api.cloud-platform-test-raz.k8s.integration.dsd.io
      name: cloud-platform-test-raz.k8s.integration.dsd.io
---
apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  name: kuberos
  annotations:
    kubernetes.io/ingress.class: "nginx"
spec:
  rules:
  - host: login.apps.cloud-platform-test-raz.k8s.integration.dsd.io
    http:
      paths:
      - path: /
        backend:
          serviceName: kuberos
          servicePort: http
---
apiVersion: v1
kind: Service
metadata:
  name: kuberos
spec:
  ports:
  - port: 80
    name: http
    targetPort: http
  selector:
    app: kuberos
---
apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: kuberos
spec:
  template:
    metadata:
      labels:
        app: kuberos
    spec:
      containers:
      - name: kuberos
        image: negz/kuberos:14f4ca7
        command:
        - "/kuberos"
        - "$(OIDC_ISSUER_URL)"
        - "$(OIDC_CLIENT_ID)"
        - "/oidc/secret"
        - "/templates/kubecfg"

        envFrom:
        - configMapRef:
            name: kuberos-oidc-env

        ports:
        - containerPort: 10003
          name: http

        volumeMounts:
        - name: oidc
          mountPath: /oidc
        - name: templates
          mountPath: /templates

      volumes:
      - name: oidc
        secret:
          secretName: kuberos-oidc

      - name: templates
        configMap:
          name: templates
